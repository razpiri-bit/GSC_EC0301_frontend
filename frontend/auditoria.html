<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoría de Cumplimiento - EC0301</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1E3A8A;
            --accent: #FF6B35;
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --light: #F8FAFC;
            --border: #E5E7EB;
            --text: #1F2937;
            --muted: #6B7280;
            --white: #FFFFFF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #F1F5F9;
            color: var(--text);
            line-height: 1.7;
        }
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-ai:hover {
            background: linear-gradient(135deg, #5a6fde 0%, #684094 100%);
        }
        .btn:disabled {
            background-color: var(--border);
            color: var(--muted);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- Estilos de Auditoría --- */
        .generation-panel {
            background: var(--white);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .generation-panel h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        .generation-panel p {
            color: var(--muted);
            margin-bottom: 1.5rem;
        }
        
        .audit-results { display: none; }

        .dictamen-box {
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 2rem;
        }
        .dictamen-box.aprobado {
            background: #F0FDF4;
            border: 2px solid var(--success);
        }
        .dictamen-box.no-cumple {
            background: #FFFBEB;
            border: 2px solid var(--danger);
        }
        .dictamen-box h2 {
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .dictamen-box.aprobado h2 { color: #166534; }
        .dictamen-box.no-cumple h2 { color: #B45309; }
        .dictamen-box p { color: var(--muted); }
        
        .progress-bar {
            width: 100%;
            background: var(--border);
            border-radius: 8px;
            height: 2.5rem;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .checklist-container {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.07);
        }
        .checklist-header {
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .checklist-body { padding: 2rem; }
        .checklist-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--border);
        }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item .icon {
            font-size: 1.5rem;
        }
        .checklist-item .icon .fa-check-circle {
            color: var(--success);
        }
        .checklist-item .icon .fa-times-circle {
            color: var(--danger);
        }
        .checklist-item .text strong {
            display: block;
            font-size: 1.1rem;
            color: var(--text);
        }
        .checklist-item .text span {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary);
            border-top: 4px solid var(--light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para impresión */
        @media print {
            body {
                background: white;
                font-family: 'Georgia', 'Times New Roman', serif;
            }
            .header,
            .btn,
            .generation-panel,
            .no-print {
                display: none !important;
            }
            .container {
                margin: 0;
                padding: 0;
            }
            .dictamen-box {
                background: var(--light) !important;
                border: 2px solid var(--border) !important;
            }
            .dictamen-box h2 {
                color: black !important;
            }
            .progress-bar {
                border: 2px solid var(--border);
            }
            .progress-fill {
                background: var(--muted) !important;
            }
            .checklist-item .icon .fa-check-circle,
            .checklist-item .icon .fa-times-circle {
                color: #333 !important;
            }
            @page {
                size: letter;
                margin: 2cm;
            }
        }
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="header-content">
            <h1><i class="fa-solid fa-shield-check" style="color: var(--accent);"></i> Auditoría de Cumplimiento</h1>
            <div>
                <a href="acceso.html" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
                <button class="btn btn-primary" onclick="printDocument()" disabled id="btn-print">
                    <i class="fa-solid fa-print"></i> Imprimir Auditoría
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="generation-panel">
            <h3><i class="fa-solid fa-robot"></i> Auditoría de Cumplimiento EC0301/EC0217.01</h3>
            <p>Este módulo leerá todos tus productos (Carta Descriptiva, Evaluaciones, Manuales, Clave de Respuestas) y los validará contra los criterios del Estándar de Competencia.</p>
            <button class="btn btn-ai" onclick="runAudit()" id="audit-button">
                <i class="fa-solid fa-play"></i> Ejecutar Auditoría con IA
            </button>
        </div>

        <div id="loading-spinner" style="display: none; text-align: center; padding: 2rem;">
            <div class="spinner"></div>
            <p style="color: var(--muted); font-weight: 600;">Analizando portafolio de productos... Esto puede tardar un momento.</p>
        </div>

        <div class="audit-results" id="audit-results-container">
            <div class="dictamen-box" id="dictamen-box">
                <h2 id="dictamen-title"></h2>
                <p id="dictamen-subtitle"></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="audit-progress-bar" style="width: 0%;">0%</div>
                </div>
                <p>A continuación se presenta el desglose de cumplimiento por Elemento y por criterio evaluado.</p>
            </div>

            <div class="checklist-container">
                <div class="checklist-header">
                    <i class="fa-solid fa-list-check"></i> Reporte Detallado de Cumplimiento
                </div>
                <div class="checklist-body" id="checklist-body">
                    </div>
            </div>
        </div>
    </main>

    <script>
    let EC0301Manager;
    let cartaData = {};
    let evaluacionSumativa = [];
    let manualesData = {};
    let respuestasData = null;

    const $ = id => document.getElementById(id);

    // ===== CORRECCIÓN: Guardia de Seguridad Robusta =====
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => { 
            if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error Crítico',
                    text: 'No se pudieron cargar los módulos de sistema (auth.js, ec0301-data-manager.js).',
                    confirmButtonColor: '#EF4444'
                }).then(() => window.location.href = 'index.html');
                return;
            }

            EC0301Manager = window.EC0301Manager;

            if (!auth.isLoggedIn()) {
                window.location.replace('index.html');
            }
        }, 50); // 50ms de espera
    });

    function showMissingDataAlert(missingProduct = 'los datos') {
        Swal.fire({
            icon: 'warning',
            title: 'Datos incompletos',
            html: `No se encontraron datos de <strong>${missingProduct}</strong>.<br><br>` +
                  'Antes de ejecutar la auditoría asegúrate de haber completado y guardado todos los módulos anteriores.',
            confirmButtonText: 'Ir a Carta Descriptiva',
            confirmButtonColor: '#1E3A8A'
        }).then(() => {
            window.location.href = 'carta_descriptiva.html';
        });
    }

    async function runAudit() {
        try {
            // 1. Cargar todos los datos
            cartaData = EC0301Manager.getData() || {};
            evaluacionSumativa = EC0301Manager.loadProduct('evaluacion-sumativa') || [];
            manualesData = EC0301Manager.loadProduct('manuales') || {};
            respuestasData = EC0301Manager.loadProduct('respuestas') || null;

            // 2. Validar que todos los productos existan
            if (!cartaData || !cartaData.nombre) {
                showMissingDataAlert('Carta Descriptiva');
                return;
            }
             if (evaluacionSumativa.length === 0) {
                showMissingDataAlert('Evaluación Sumativa');
                return;
            }
            if (!manualesData.participante || !manualesData.instructor) {
                showMissingDataAlert('Manuales');
                return;
            }
             if (!respuestasData) {
                showMissingDataAlert('Hoja de Respuestas');
                return;
            }
        } catch (error) {
            console.error('Error al cargar datos para auditoría:', error);
            showMissingDataAlert('los datos');
            return;
        }

        // 3. Mostrar Spinner
        $('audit-button').disabled = true;
        $('loading-spinner').style.display = 'block';
        $('audit-results-container').style.display = 'none';

        // 4. Simular procesamiento de IA
        await new Promise(resolve => setTimeout(resolve, 2500));

        // 5. Ejecutar la lógica de auditoría
        const auditResults = runECAudit_EC0217();
        
        // 6. Ocultar Spinner
        $('loading-spinner').style.display = 'none';
        $('audit-results-container').style.display = 'block';

        // 7. Mostrar resultados
        renderAuditResults(auditResults);
        
        $('audit-button').disabled = false;
        $('btn-print').disabled = false; // Activar botón de imprimir
    }
    
    /**
     * ===== FUNCIÓN DE AUDITORÍA ACTUALIZADA =====
     * Motor de auditoría EC0301/EC0217:
     * Valida contra los campos de la Carta Descriptiva "inteligente" (presencial).
     */
    function runECAudit_EC0217() {
        const checklist = [];
        let totalCriteria = 0;
        let passedCriteria = 0;

        const byElement = {
            1: { total: 0, passed: 0, nombre: 'Elemento 1: Carta Descriptiva' },
            2: { total: 0, passed: 0, nombre: 'Elemento 2: Instrumentos de Evaluación' },
            3: { total: 0, passed: 0, nombre: 'Elemento 3: Manuales del Curso' }
        };

        const check = (elemento, condition, titulo, okDetail, failDetail, recomendacion) => {
            const pass = !!(condition); // Asegura que sea booleano
            totalCriteria++;
            if (byElement[elemento]) {
                byElement[elemento].total++;
                if (pass) byElement[elemento].passed++;
            }
            if (pass) {
                passedCriteria++;
            }
            checklist.push({
                elemento, pass, titulo, okDetail, failDetail, recomendacion
            });
        };

        // =====================================================
        // ELEMENTO 1 – CARTA DESCRIPTIVA (EC0217.01)
        // =====================================================

        check(1,
            cartaData.nombre, 'Nombre del curso',
            'El curso tiene un nombre definido.',
            'No se ha definido el nombre del curso.',
            'Define un nombre claro para tu curso en la Sección 1.'
        );
        check(1,
            cartaData.facilitador, 'Nombre del facilitador',
            'Se identifica al facilitador del curso.',
            'No se ha capturado el nombre del facilitador.',
            'Registra el nombre del facilitador en la Sección 1.'
        );
        check(1,
            cartaData.perfil, 'Perfil del participante',
            'El perfil del participante describe las características del grupo.',
            'No se describe claramente el perfil del participante.',
            'Define el perfil de los participantes en la Sección 2.'
        );
        check(1,
            cartaData.num, 'Número de participantes',
            'Se especifica el número de participantes.',
            'No se ha indicado el número de participantes.',
            'Establece el número de participantes en la Sección 2.'
        );
        check(1,
            cartaData.og && cartaData.og.accion && cartaData.og.cond && cartaData.og.criterio,
            'Objetivo general estructurado',
            'El objetivo general integra Acción, Condición y Criterio.',
            'El objetivo general no está completo (falta Acción, Condición o Criterio).',
            'Revisa la Sección 3 y completa todos los campos del Objetivo General.'
        );
        check(1,
            Array.isArray(cartaData.objetivos) && cartaData.objetivos.length === 4 &&
            cartaData.objetivos.every(o => o.accion && o.cond),
            'Objetivos particulares (4 dominios)',
            'Se definen los 4 objetivos particulares (Cognitivo, Psicomotor, Afectivo, Relacional).',
            'Falta definir o completar uno o más de los 4 objetivos particulares.',
            'Revisa la Sección 3 y completa la "Acción" y "Condición" para los 4 objetivos.'
        );
        check(1,
            Array.isArray(cartaData.temas) && cartaData.temas.length > 0 &&
            cartaData.temas.every(t => t.nombre && t.duracion),
            'Temario del curso (Desarrollo)',
            'El curso cuenta con un temario estructurado por temas, cada uno con nombre y duración.',
            'No se ha capturado el temario o a un tema le falta nombre o duración.',
            'Ve a la Sección 6 (Desarrollo) y añade al menos un tema con nombre y duración.'
        );
        check(1,
            cartaData.ev && cartaData.ev.diag_ins && cartaData.ev.form_ins && cartaData.ev.sum_ins && cartaData.ev.sat_ins,
            'Estrategia de evaluación (4 instrumentos)',
            'Se describen los 4 instrumentos de evaluación (Diag, Form, Sum, Sat).',
            'Falta describir uno o más instrumentos en la Sección 5.',
            'Revisa la Sección 5 y asegúrate de que los 4 tipos de evaluación tengan instrumentos definidos.'
        );
        check(1,
            cartaData.rq && cartaData.rq.instalaciones && cartaData.rq.equipo && cartaData.rq.materiales && cartaData.rq.humanos && cartaData.rq.seguridad,
            'Lista de Requerimientos Completa',
            'Se listan todos los requerimientos (Instalaciones, Equipo, Materiales, Humanos, Seguridad).',
            'Falta definir uno o más tipos de requerimientos en la Sección 4.',
            'Completa todas las cajas de texto de la Sección 4 de Requerimientos.'
        );
        check(1,
            cartaData.dev && cartaData.dev.comprobacion_t && cartaData.dev.enc_1_t && cartaData.dev.cierre_1_t,
            'Desarrollo Cronológico (Tiempos)',
            'Se asignan tiempos a las etapas de Comprobación, Encuadre y Cierre.',
            'No se han definido los tiempos en la Sección 6.',
            'Revisa la Sección 6 y asigna tiempos (en minutos) a las etapas de Comprobación, Encuadre y Cierre.'
        );

        // =====================================================
        // ELEMENTO 2 – INSTRUMENTOS DE EVALUACIÓN
        // =====================================================

        check(2,
            evaluacionSumativa && evaluacionSumativa.length > 0,
            'Banco de reactivos (Sumativa)',
            'Se ha generado el banco de reactivos de la Evaluación Sumativa.',
            'No se ha generado el banco de reactivos para la Evaluación Sumativa.',
            'Ve al Módulo "Evaluaciones", pestaña "Sumativa", y genera o agrega al menos un reactivo.'
        );
        check(2,
            evaluacionSumativa.every(p => p.pregunta && Array.isArray(p.opciones) && p.opciones.length >= 4),
            'Reactivos sumativos completos',
            'Todos los reactivos sumativos tienen pregunta y al menos 4 opciones de respuesta.',
            'Hay reactivos incompletos (sin pregunta o sin las 4 opciones).',
            'Revisa el "Banco de Reactivos" y completa los textos de pregunta y las 4 opciones en cada reactivo.'
        );
        check(2,
            evaluacionSumativa.every(p => p.opciones && p.opciones.some(o => o.correcta)),
            'Clave interna de reactivos (Sumativa)',
            'Cada reactivo sumativo tiene marcada una opción como "correcta".',
            'Hay reactivos sumativos sin opción correcta marcada.',
            'Marca la opción correcta en cada reactivo (clic en el radio button) antes de guardar.'
        );
        check(2,
            !!respuestasData,
            'Clave de respuestas consolidada (Producto)',
            'Se ha generado el producto "Clave de Respuestas".',
            'No se ha generado el producto de "Clave de Respuestas".',
            'Ve al módulo "Hoja de Respuestas" y verifica que los datos se carguen. El sistema lo guardará automáticamente.'
        );
        check(2,
            !!cartaData.ev?.sat_ins,
            'Instrumento de satisfacción definido',
            'La Carta Descriptiva define el instrumento de satisfacción/reacción.',
            'No se ha definido el instrumento de satisfacción en la Carta Descriptiva.',
            'Revisa la Sección 5 de la Carta Descriptiva y define el instrumento de satisfacción.'
        );

        // =====================================================
        // ELEMENTO 3 – MANUALES DEL CURSO
        // =====================================================

        const manualParticipante = manualesData.participante || null;
        const manualInstructor = manualesData.instructor || null;

        check(3,
            !!manualParticipante,
            'Manual del participante generado',
            'Existe un manual del participante en el sistema.',
            'No se ha generado el manual del participante.',
            'Ve al Módulo "Manuales", pestaña "Participante", y genera el manual con IA.'
        );
        check(3,
            !!manualInstructor,
            'Manual del instructor generado',
            'Existe un manual del instructor en el sistema.',
            'No se ha generado el manual del instructor.',
            'Ve al Módulo "Manuales", pestaña "Instructor", y genera el manual con IA.'
        );
        check(3,
            manualParticipante && manualParticipante.cover && manualParticipante.cover.title,
            'Portada (Manual Participante)',
            'El manual del participante incluye una portada con título.',
            'La portada del manual del participante no está completa.',
            'Asegúrate de que el Manual del Participante tenga una portada con título.'
        );
        check(3,
            manualParticipante && Array.isArray(manualParticipante.sections) &&
            manualParticipante.sections.some(s => s.id === 'bienvenida'),
            'Introducción (Manual Participante)',
            'El manual del participante incluye una sección de Bienvenida/Introducción.',
            'Falta la sección de Introducción en el manual del participante.',
            'Asegúrate de que el manual generado incluya una introducción.'
        );
        check(3,
            manualParticipante && manualParticipante.sections.some(s => s.id === 'cierre'),
            'Sistema de evaluación (Manual Participante)',
            'El manual del participante explica cómo será evaluado el participante (en la sección de Cierre).',
            'No se describe el sistema de evaluación en el manual del participante.',
            'Asegúrate de que el manual generado incluya una sección de Cierre/Evaluación.'
        );
        check(3,
            manualInstructor && manualInstructor.cover && manualInstructor.cover.title,
            'Portada (Manual Instructor)',
            'El manual del instructor incluye portada con título.',
            'La portada del manual del instructor no está completa.',
            'Asegúrate de que el Manual del Instructor tenga una portada con título.'
        );
        check(3,
            manualInstructor && manualInstructor.sections.some(s => s.content.includes('instructor-note')),
            'Notas del instructor (Manual Instructor)',
            'El manual del instructor integra notas, sugerencias didácticas y estrategias de facilitación.',
            'No se han encontrado "Notas del Instructor" en el manual.',
            'Asegúrate de que el manual del instructor se genere correctamente, incluyendo las notas didácticas.'
        );
        check(3,
            manualInstructor && cartaData.temas && cartaData.temas.length > 0 && manualInstructor.sections.some(s => s.title.includes(cartaData.temas[0]?.nombre || 'Tema 1')),
            'Desarrollo de Temas (Manual Instructor)',
            'El manual del instructor desarrolla los temas de la Carta Descriptiva.',
            'El temario del manual del instructor no coincide con la Carta Descriptiva.',
            'Vuelve a generar el Manual del Instructor después de guardar la versión final de tu temario.'
        );

        // =====================================================
        // Cálculo del porcentaje global
        // =====================================================
        const percentage = totalCriteria > 0
            ? Math.round((passedCriteria / totalCriteria) * 100)
            : 0;

        Object.keys(byElement).forEach(key => {
            const el = byElement[key];
            el.porcentaje = el.total > 0
                ? Math.round((el.passed / el.total) * 100)
                : 0;
        });

        return { checklist, percentage, byElement };
    }


    function renderAuditResults({ checklist, percentage, byElement }) {
        const dictamenBox     = $('dictamen-box');
        const dictamenTitle   = $('dictamen-title');
        const dictamenSubtitle = $('dictamen-subtitle');
        const progressBar     = $('audit-progress-bar');

        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';

        if (percentage === 100) {
            dictamenBox.className = 'dictamen-box aprobado';
            dictamenTitle.innerHTML = '<i class="fa-solid fa-check-circle"></i> APROBADO';
            dictamenSubtitle.textContent =
                '¡Felicidades! Tu portafolio de productos cumple al 100% con los criterios revisados del EC0301.';
            progressBar.style.backgroundColor = 'var(--success)';
        } else {
            dictamenBox.className = 'dictamen-box no-cumple';
            dictamenTitle.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> NO CUMPLE AL 100%';
            dictamenSubtitle.textContent =
                `Tu portafolio tiene un ${percentage}% de cumplimiento. Revisa las áreas de mejora listadas abajo.`;
            progressBar.style.backgroundColor = (percentage >= 70 ? 'var(--warning)' : 'var(--danger)');
        }

        const checklistBody = $('checklist-body');
        checklistBody.innerHTML = '';

        // Resumen por Elemento
        const resumenWrapper = document.createElement('div');
        resumenWrapper.style.display = 'grid';
        resumenWrapper.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
        resumenWrapper.style.gap = '1rem';
        resumenWrapper.style.marginBottom = '1.5rem';

        [1, 2, 3].forEach(num => {
            const el = byElement[num];
            const card = document.createElement('div');
            card.style.border = '1px solid var(--border)';
            card.style.borderRadius = '10px';
            card.style.padding = '1rem 1.25rem';
            card.style.background = '#F9FAFB';

            const color = el.porcentaje === 100
                ? '#16A34A'
                : (el.porcentaje >= 70 ? '#F59E0B' : '#DC2626');

            card.innerHTML = `
                <strong style="display:block; margin-bottom:0.25rem;">${el.nombre}</strong>
                <span style="font-size:0.9rem; color:var(--muted);">
                    Criterios cumplidos: ${el.passed}/${el.total}
                </span>
                <div style="margin-top:0.5rem; font-weight:700; color:${color};">
                    ${el.porcentaje}% de cumplimiento
                </div>
            `;
            resumenWrapper.appendChild(card);
        });

        checklistBody.appendChild(resumenWrapper);

        // Detalle de Criterios
        checklist.forEach(item => {
            const row = document.createElement('div');
            row.className = 'checklist-item';

            const icon = item.pass
                ? '<i class="fa-solid fa-check-circle"></i>'
                : '<i class="fa-solid fa-times-circle"></i>';

            const colorDetalle = item.pass ? 'var(--muted)' : 'var(--danger)';
            const detalle = item.pass ? item.okDetail : item.failDetail;

            row.innerHTML = `
                <div class="icon">${icon}</div>
                <div class="text">
                    <strong>Elemento ${item.elemento} – ${item.titulo}</strong>
                    <span style="display:block; margin-top:0.15rem; color:${colorDetalle};">
                        ${detalle}
                    </span>
                    ${!item.pass && item.recomendacion ? `
                        <span style="display:block; margin-top:0.3rem; font-size:0.85rem; color:#374151;">
                            <strong>Recomendación:</strong> ${item.recomendacion}
                        </span>
                    ` : ''}
                </div>
            `;
            checklistBody.appendChild(row);
        });
    }

    function printDocument() {
        window.print();
    }
    </script>
</body>
</html>
