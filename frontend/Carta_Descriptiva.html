<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Descriptiva EC0217.01 - SkillsCert Professional</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
            --accent: #FF6B35; --success: #10b981; --warning: #F59E0B;
            --danger: #ef4444; --dark: #1e293b; --light: #f1f5f9;
            --white: #ffffff; --border: #e2e8f0; --shadow: 0 10px 30px rgba(99, 102, 241, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            padding-bottom: 4rem;
        }
        /* HEADER */
        .header { background: var(--white); box-shadow: 0 2px 20px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--primary); }
        .header-content { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-title h1 { font-size: 1.5rem; color: var(--dark); margin: 0; font-weight: 700; }
        .header-title .subtitle { font-size: 0.85rem; color: #64748b; font-weight: 400; }
        .toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.65rem 1.25rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; color: white; text-decoration: none; }
        .btn-secondary { background: #64748b; } .btn-secondary:hover { background: #475569; }
        .btn-primary { background: var(--primary); } .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); } .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); } .btn-warning:hover { background: #d97706; }
        .btn-danger { background: var(--danger); }
        .progress-container { background: var(--light); height: 8px; width: 100%; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); transition: width 0.5s ease; }
        /* MAIN */
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .section { background: var(--white); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .section-title { color: var(--primary); font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--light); display: flex; align-items: center; gap: 0.5rem; }
        /* FORMS */
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem; }
        label .required { color: var(--danger); }
        input, select, textarea { width: 100%; padding: 0.85rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: all 0.3s; background: var(--white); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        textarea { min-height: 130px; resize: vertical; }
        /* GRID & BOXES */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .box { background: var(--light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .box h3 { margin-bottom: 1rem; font-size: 1.1rem; color: var(--dark); display: flex; justify-content: space-between; }
        .time-badge { background: var(--primary); color: white; padding: 0.2rem 0.8rem; border-radius: 20px; font-size: 0.8rem; }
        .doms { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .dom { padding: 0.5rem 1rem; background: white; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: #64748b; cursor: pointer; }
        .dom.active { background: var(--primary); color: white; border-color: var(--primary); }
        .verbos-container { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; border: 1px solid var(--border); }
        .verbo { display: inline-block; padding: 0.3rem 0.8rem; margin: 0.2rem; background: var(--light); border-radius: 15px; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s; }
        .verbo:hover { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
        .validation-indicator { position: fixed; bottom: 2rem; right: 2rem; background: white; padding: 1rem 1.5rem; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 0.8rem; font-weight: 600; z-index: 100; transition: all 0.3s; }
        .validation-indicator.valid { border: 2px solid var(--success); color: var(--success); }
        .validation-indicator.invalid { border: 2px solid var(--danger); color: var(--danger); }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-file-signature"></i>
                <div>
                    <h1>Carta Descriptiva</h1>
                    <span class="subtitle">EC0217.01 (Presencial) / EC0301 (Dise帽o)</span>
                </div>
            </div>
            <div class="toolbar">
                <a href="acceso.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Dashboard</a>
                <button class="btn btn-primary" onclick="saveDraft()"><i class="fas fa-save"></i> Guardar</button>
                <button class="btn btn-success" onclick="markComplete()"><i class="fas fa-check-circle"></i> Completar</button>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
    </header>

    <main class="container">
        
        <section class="section">
            <h2 class="section-title"><i class="fas fa-info-circle"></i> 1. Informaci贸n General del Curso</h2>
            <div class="grid-3">
                <div class="form-group">
                    <label>Nombre del Curso-Taller <span class="required">*</span></label>
                    <input id="cd_nombre" placeholder="Ej: Curso de Inducci贸n..." required>
                </div>
                <div class="form-group">
                    <label>Nombre del Facilitador/Instructor <span class="required">*</span></label>
                    <input id="cd_facilitador" required>
                </div>
                <div class="form-group">
                    <label>Lugar de Instrucci贸n</label>
                    <input id="cd_lugar" placeholder="Ej: Sala de Juntas A">
                </div>
            </div>
            <div class="grid-3">
                <div class="form-group">
                    <label>Duraci贸n (horas) <span class="required">*</span></label>
                    <input type="number" id="cd_duracion" placeholder="Ej: 5" required onchange="recalcTimes()">
                </div>
                <div class="form-group">
                    <label>Fecha(s)</label>
                    <input id="cd_fecha" placeholder="Ej: 15 y 16 de Octubre">
                </div>
                <div class="form-group">
                    <label>Modalidad del Curso <span class="required">*</span></label>
                    <select id="cd_modalidad" required>
                        <option value="">Seleccione...</option>
                        <option value="presencial">Presencial</option>
                        <option value="mixto">Mixto (L铆nea y Presencial)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Nombre del Dise帽ador <span class="required">*</span></label>
                <input id="cd_dise帽ador" required>
            </div>
            <div class="form-group">
                <label>Prop贸sito/Beneficio del curso <span class="required">*</span></label>
                <textarea id="cd_proposito" placeholder="El participante adquirir谩..." required></textarea>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title"><i class="fas fa-users"></i> 2. Perfil del Participante</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Perfil de ingreso (Conocimientos/Habilidades) <span class="required">*</span></label>
                    <textarea id="cd_perfil" required></textarea>
                </div>
                <div class="form-group">
                    <label>Conocimientos previos requeridos <span class="required">*</span></label>
                    <textarea id="cd_conoc" required></textarea>
                </div>
                <div class="form-group">
                    <label>Habilidades tecnol贸gicas requeridas</label>
                    <textarea id="cd_hab"></textarea>
                </div>
                <div class="form-group">
                    <label>Actitudes deseables</label>
                    <textarea id="cd_actitudes"></textarea>
                </div>
                <div class="form-group">
                    <label>N煤mero de participantes</label>
                    <input id="cd_num" placeholder="Ej: 15">
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title"><i class="fas fa-bullseye"></i> 3. Objetivos de Aprendizaje</h2>
            
            <div class="box">
                <h3>Objetivo General</h3>
                <div class="form-group">
                    <label>El participante (Sujeto):</label>
                    <input value="Al finalizar el curso, el participante..." disabled style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Acci贸n/Comportamiento (Verbo en futuro) <span class="required">*</span></label>
                    <textarea id="og_accion" placeholder="Ej: aplicar谩 los procedimientos de seguridad..." required onkeyup="updateOG()"></textarea>
                </div>
                <div class="form-group">
                    <label>Condici贸n de Operaci贸n <span class="required">*</span></label>
                    <textarea id="og_cond" placeholder="Ej: de acuerdo con el manual de operaciones y utilizando el equipo de protecci贸n..." required onkeyup="updateOG()"></textarea>
                </div>
                <input type="hidden" id="og_criterio" value="seg煤n lo establecido en la secci贸n de evaluaci贸n">
                
                <div class="preview-box" style="margin-top: 1rem; background: #e0e7ff; padding: 1rem; border-radius: 8px;">
                    <strong>Vista previa:</strong>
                    <div id="og_preview" style="font-style: italic;">Complete los campos...</div>
                </div>
            </div>

            <div id="objetivosParticulares">
                </div>
        </section>

        <section class="section">
            <h2 class="section-title"><i class="fas fa-clipboard-list"></i> 4. Requerimientos del Curso</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Requerimientos en instalaciones, mobiliario y su distribuci贸n: <span class="required">*</span></label>
                    <textarea id="rq_instalaciones" required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos en equipo de apoyo y su distribuci贸n: <span class="required">*</span></label>
                    <textarea id="rq_equipo" required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos en materiales de apoyo: <span class="required">*</span></label>
                    <textarea id="rq_materiales" required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos humanos:</label>
                    <textarea id="rq_humanos"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label>Material y equipo para las medidas de salud/seguridad/higiene/protecci贸n civil: <span class="required">*</span></label>
                <textarea id="rq_seguridad" required></textarea>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title"><i class="fas fa-check-double"></i> 5. Sistema de Evaluaci贸n</h2>
            <div class="grid-4">
                <div class="box">
                    <h4>Diagn贸stica</h4>
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_diag_pct" value="10" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumento</label>
                        <input id="ev_diag_ins" value="Cuestionario">
                    </div>
                </div>
                <div class="box">
                    <h4>Formativa</h4>
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_form_pct" value="50" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumento</label>
                        <input id="ev_form_ins" value="Gu铆a de Observaci贸n">
                    </div>
                </div>
                <div class="box">
                    <h4>Sumativa</h4>
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_sum_pct" value="40" oninput="sumarPorcentajes()">
                    </div>
                    <div class="form-group">
                        <label>Instrumento</label>
                        <input id="ev_sum_ins" value="Cuestionario">
                    </div>
                </div>
                <div class="box">
                    <h4>Satisfacci贸n</h4>
                    <div class="form-group">
                        <label>Porcentaje (%)</label>
                        <input type="number" id="ev_sat_pct" value="0" disabled style="background: #eee;">
                    </div>
                    <div class="form-group">
                        <label>Instrumento</label>
                        <input id="ev_sat_ins" value="Encuesta" disabled>
                    </div>
                </div>
            </div>
            <div style="text-align: right; font-size: 1.2rem; font-weight: bold; margin-top: 1rem;">
                Suma Total: <span id="ev_total_pct">100%</span>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title"><i class="fas fa-list-ol"></i> 6. Desarrollo Cronol贸gico (Guion)</h2>

            <div class="box" style="border-left: 4px solid var(--warning);">
                <h3><span class="time-badge" id="precursoTime">30 min</span> Comprobaci贸n de Recursos (Previo)</h3>
                <div class="form-group">
                    <label>Actividades de verificaci贸n:</label>
                    <textarea id="dc_verificacion" rows="4">1. Verificar mobiliario y distribuci贸n.&#10;2. Probar equipo de c贸mputo y proyecci贸n.&#10;3. Verificar material did谩ctico suficiente.&#10;4. Verificar condiciones de seguridad e higiene.</textarea>
                </div>
                <div class="form-group">
                    <label>Tiempo (min):</label>
                    <input type="number" id="dc_precurso_t" value="30" style="width: 100px;" onchange="recalcTimes()">
                </div>
            </div>

            <div class="box">
                <h3><span class="time-badge" id="encuadreTime">0 min</span> Etapa de Encuadre / Apertura</h3>
                <div class="form-group">
                    <label>1. Presentaci贸n del instructor y participantes (T茅cnica Rompehielo):</label>
                    <textarea id="enc_1_presentacion" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>2. Presentaci贸n del curso (Objetivos y Temario):</label>
                    <textarea id="enc_2_curso" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>3. Momentos e instrumentos de evaluaci贸n:</label>
                    <textarea id="enc_3_evaluacion" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>4. Acuerdos y compromisos (Reglas):</label>
                    <textarea id="enc_4_acuerdos" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>5. Evaluaci贸n diagn贸stica:</label>
                    <textarea id="enc_5_diagnostico" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Tiempo Total Encuadre (min):</label>
                    <input type="number" id="dc_encuadre_t" value="30" style="width: 100px;" onchange="recalcTimes()">
                </div>
            </div>

            <div class="box">
                <h3><span class="time-badge" id="desarrolloTime">0 min</span> Desarrollo (Temario)</h3>
                <div id="temasContainer"></div>
                <button class="btn btn-primary" onclick="addTema()"><i class="fas fa-plus"></i> Agregar Tema/M贸dulo</button>
            </div>

            <div class="box">
                <h3><span class="time-badge" id="cierreTime">0 min</span> Cierre del Curso</h3>
                <div class="form-group">
                    <label>1. Conclusiones y resumen:</label>
                    <textarea id="cierre_1_resumen" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>2. Logro de expectativas y objetivos:</label>
                    <textarea id="cierre_2_logro" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>3. Sugerencias de continuidad:</label>
                    <textarea id="cierre_3_sugerencias" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>4. Evaluaci贸n de satisfacci贸n:</label>
                    <textarea id="cierre_4_satisfaccion" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>5. Despedida:</label>
                    <textarea id="cierre_5_despedida" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Tiempo Total Cierre (min):</label>
                    <input type="number" id="dc_cierre_t" value="15" style="width: 100px;" onchange="recalcTimes()">
                </div>
            </div>

            <div class="box" style="background: #e0e7ff; border-color: var(--primary);">
                <h3 style="justify-content: flex-end;">
                    Tiempo Total Calculado: 
                    <span id="sum_total" style="color: var(--primary-dark); margin-left: 1rem;">0 min</span>
                </h3>
                <p id="time_warning" style="color: var(--danger); text-align: right; display: none; font-weight: bold;">
                    <i class="fas fa-exclamation-triangle"></i> El tiempo no coincide con la duraci贸n total del curso.
                </p>
            </div>
        </section>

    </main>

    <div class="validation-indicator invalid" id="validationIndicator">
        <i class="fas fa-times-circle"></i>
        <span>0% Completado</span>
    </div>

    <script>
        // --- CONFIGURACIN ---
        const VERBOS = {
            cognitivo: {
                conocimiento: ['Identificar', 'Reconocer', 'Listar', 'Nombrar', 'Definir', 'Describir'],
                comprension: ['Explicar', 'Interpretar', 'Resumir', 'Clasificar', 'Comparar', 'Ejemplificar'],
                aplicacion: ['Aplicar', 'Usar', 'Implementar', 'Ejecutar', 'Resolver', 'Demostrar'],
                analisis: ['Analizar', 'Diferenciar', 'Organizar', 'Relacionar', 'Examinar', 'Contrastar'],
                evaluacion: ['Evaluar', 'Criticar', 'Justificar', 'Argumentar', 'Validar', 'Decidir'],
                creacion: ['Crear', 'Dise帽ar', 'Construir', 'Planear', 'Producir', 'Desarrollar']
            },
            psicomotriz: { 
                imitacion: ['Imitar', 'Copiar', 'Repetir', 'Reproducir', 'Seguir'],
                manipulacion: ['Manipular', 'Operar', 'Practicar', 'Ejecutar', 'Manejar'],
                precision: ['Demostrar', 'Completar', 'Mostrar', 'Calibrar', 'Controlar'],
                articulacion: ['Coordinar', 'Integrar', 'Adaptar', 'Modificar', 'Masterizar'],
                naturalizacion: ['Dise帽ar', 'Especificar', 'Gestionar', 'Inventar', 'Proyectar']
            },
            afectivo: {
                recepcion: ['Escuchar', 'Atender', 'Percibir', 'Recibir', 'Aceptar'],
                respuesta: ['Participar', 'Responder', 'Asistir', 'Practicar', 'Informar'],
                valoracion: ['Valorar', 'Apreciar', 'Justificar', 'Proponer', 'Compartir'],
                organizacion: ['Organizar', 'Integrar', 'Sintetizar', 'Priorizar', 'Combinar'],
                caracterizacion: ['Actuar', 'Discriminar', 'Influir', 'Modificar', 'Revisar']
            },
            relacional: { 
                interaccion: ['Interactuar', 'Comunicar', 'Relacionar', 'Contactar', 'Dialogar'],
                colaboracion: ['Colaborar', 'Cooperar', 'Contribuir', 'Ayudar', 'Apoyar'],
                liderazgo: ['Liderar', 'Dirigir', 'Guiar', 'Motivar', 'Inspirar'],
                negociacion: ['Negociar', 'Mediar', 'Conciliar', 'Acordar', 'Resolver'],
                facilitacion: ['Facilitar', 'Moderar', 'Coordinar', 'Dinamizar', 'Gestionar']
            }
        };

        let objetivosCount = 0;
        let temasCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                 // Auth Check
                if (typeof auth !== 'undefined' && !auth.isLoggedIn()) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Inicializar
                if (typeof EC0301Manager !== 'undefined') {
                    initForm();
                } else {
                    console.error('EC0301Manager no cargado');
                }
            }, 50);
        });

        function initForm() {
            // Cargar datos si existen
            loadDraft();
            
            // Si es nuevo, inicializar estructuras
            if (objetivosCount === 0) {
                addObjetivoParticular('Cognitivo');
                addObjetivoParticular('Psicomotriz');
                addObjetivoParticular('Afectivo');
                addObjetivoParticular('Relacional');
            }
            if (temasCount === 0) addTema();

            recalcTimes();
            sumarPorcentajes();
            updateProgress();
            
            // Activar listener de cambios para todo
            attachProgressListeners();

            // Auto-save
            setInterval(() => {
                if (updateProgress() > 5) saveDraft(true);
            }, 30000);
        }

        // Funci贸n para recalcular progreso al escribir
        function attachProgressListeners() {
            const elementos = document.querySelectorAll('input, textarea, select');
            elementos.forEach(el => {
                el.addEventListener('input', updateProgress);
                el.addEventListener('change', updateProgress);
            });
        }

        // --- LGICA DE OBJETIVOS ---
        function addObjetivoParticular(dominioName) {
            objetivosCount++;
            const container = document.getElementById('objetivosParticulares');
            const div = document.createElement('div');
            div.className = 'box';
            div.setAttribute('data-op', objetivosCount);
            
            // Determinar dominio si no se pasa
            let dominioFijo = dominioName;
             if (!dominioFijo) {
                 const dominios = ['Cognitivo', 'Psicomotriz', 'Afectivo', 'Relacional'];
                 dominioFijo = (objetivosCount <= 4) ? dominios[objetivosCount-1] : 'Cognitivo';
             }

             // Construir selector de dominios
             const dominios = ['Cognitivo', 'Psicomotriz', 'Afectivo', 'Relacional'];
             let domsHTML = dominios.map(d => 
                `<div class="dom ${d.toLowerCase() === dominioFijo.toLowerCase() ? 'active' : ''}" onclick="selDom(${objetivosCount}, '${d.toLowerCase()}')">${d}</div>`
            ).join('');

            div.innerHTML = `
                <h3>Objetivo Particular ${objetivosCount}: <span style="color:var(--primary)">${dominioFijo}</span></h3>
                <div class="doms" data-op="${objetivosCount}">${domsHTML}</div>
                <div class="verbos-container" id="verbs${objetivosCount}"></div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Verbo + Acci贸n</label>
                        <input id="op${objetivosCount}_accion" placeholder="Ej: Identificar谩..." >
                    </div>
                    <div class="form-group">
                        <label>Condici贸n de Operaci贸n</label>
                        <textarea id="op${objetivosCount}_cond" placeholder="Ej: A trav茅s de..."></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label>Temas Relacionados</label>
                    <textarea id="op${objetivosCount}_temas"></textarea>
                </div>
            `;
            container.appendChild(div);
            renderVerbos(objetivosCount, dominioFijo.toLowerCase());
            
            // Volver a adjuntar listeners a los nuevos elementos
            attachProgressListeners();
        }
        
        function selDom(n, dominio) {
            const container = document.querySelector(`div[data-op="${n}"] .doms`);
            container.querySelectorAll('.dom').forEach(d => d.classList.remove('active'));
            // Buscar por texto porque el onclick pasa el string
            Array.from(container.querySelectorAll('.dom')).find(el => el.textContent.toLowerCase() === dominio).classList.add('active');
            renderVerbos(n, dominio);
        }

        function renderVerbos(n, dominio) {
            const container = document.getElementById(`verbs${n}`);
            if (!container) return;
            let html = '<small> Verbos sugeridos (clic para usar):</small>';
            const categorias = VERBOS[dominio] || VERBOS.cognitivo;
            for (const [categoria, verbos] of Object.entries(categorias)) {
                html += `<div class="verbo-category">
                    <strong>${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:</strong><br>
                    ${verbos.map(v => `<span class="verbo" onclick="insertVerbo(${n}, '${v}')">${v}</span>`).join('')}
                </div>`;
            }
            container.innerHTML = html;
        }

        function insertVerbo(n, verbo) {
            const input = document.getElementById(`op${n}_accion`);
            if (!input) return;
            const textoActual = input.value.trim();
            if (!textoActual) {
                input.value = verbo + ' ';
            } else if (!textoActual.startsWith(verbo)) {
                input.value = verbo + ' ' + textoActual;
            }
            input.focus();
            updateProgress();
        }
        
        function updateOG() {
             const sujeto = 'Al finalizar el curso, el participante';
            const accion = document.getElementById('og_accion').value.trim();
            const condicion = document.getElementById('og_cond').value.trim();
            
            let preview = sujeto;
            if (accion) preview += ' ' + accion;
            if (condicion) preview += ', ' + condicion;
            
            document.getElementById('og_preview').innerHTML = preview + '.';
        }


        // --- LGICA DE TEMAS ---
        function addTema() {
            temasCount++;
            const container = document.getElementById('temasContainer');
            const div = document.createElement('div');
            div.className = 'box';
            div.setAttribute('data-tema', temasCount);
            div.innerHTML = `
                <h3>Tema ${temasCount} 
                    <button class="btn btn-danger" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="removeTema(this)">Eliminar</button>
                </h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Nombre del Tema/Subtema</label>
                        <input id="tema${temasCount}_nombre">
                    </div>
                    <div class="form-group">
                        <label>Duraci贸n (min)</label>
                        <input type="number" id="tema${temasCount}_duracion" value="0" onchange="recalcTimes()">
                    </div>
                </div>
                <div class="form-group">
                    <label>Actividades (Instructor/Participante)</label>
                    <textarea id="tema${temasCount}_actividades"></textarea>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>T茅cnicas</label>
                        <input id="tema${temasCount}_tecnicas">
                    </div>
                    <div class="form-group">
                        <label>Material y Equipo</label>
                        <input id="tema${temasCount}_material">
                    </div>
                </div>
            `;
            container.appendChild(div);
            attachProgressListeners(); // Re-adjuntar listeners
        }

        function removeTema(btn) {
            btn.closest('.box').remove();
            recalcTimes();
            updateProgress();
        }

        // --- CLCULOS ---
        function recalcTimes() {
            let desarrollo = 0;
            document.querySelectorAll('[id^="tema"][id$="_duracion"]').forEach(el => {
                desarrollo += parseInt(el.value) || 0;
            });
            
            const encuadre = parseInt(document.getElementById('dc_encuadre_t').value) || 0;
            const cierre = parseInt(document.getElementById('dc_cierre_t').value) || 0;
            
            const totalMin = encuadre + desarrollo + cierre;
            const totalHrs = (totalMin / 60).toFixed(1);
            
            document.getElementById('desarrolloTime').innerText = `${desarrollo} min`;
            document.getElementById('sum_total').innerText = `${totalMin} min (${totalHrs} hrs)`;

            // Validar vs Duraci贸n Total
            const duracionObjetivo = parseInt(document.getElementById('cd_duracion').value) * 60 || 0;
            const warning = document.getElementById('time_warning');
            
            if (duracionObjetivo > 0 && Math.abs(duracionObjetivo - totalMin) > 5) {
                warning.style.display = 'block';
                warning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> El tiempo planificado (${totalMin} min) no coincide con la duraci贸n total (${duracionObjetivo} min).`;
            } else {
                warning.style.display = 'none';
            }
        }

        function sumarPorcentajes() {
            const p1 = parseInt(document.getElementById('ev_diag_pct').value) || 0;
            const p2 = parseInt(document.getElementById('ev_form_pct').value) || 0;
            const p3 = parseInt(document.getElementById('ev_sum_pct').value) || 0;
            const total = p1 + p2 + p3;
            
            const el = document.getElementById('ev_total_pct');
            el.innerText = total + '%';
            el.style.color = total === 100 ? 'var(--success)' : 'var(--danger)';
        }

        // --- VALIDACIN Y GUARDADO ---
        function updateProgress() {
            // Lista de IDs clave que deben tener valor
            const requiredIds = [
                'cd_nombre', 'cd_facilitador', 'cd_lugar', 'cd_fecha', 'cd_modalidad', 'cd_proposito',
                'cd_perfil', 'cd_conoc', 'cd_hab', 'cd_actitudes', 'cd_num',
                'og_accion', 'og_cond',
                // Objetivos Particulares (al menos los primeros inputs de los fijos)
                'op1_accion', 'op1_cond', 'op2_accion', 'op2_cond', 'op3_accion', 'op3_cond', 'op4_accion', 'op4_cond',
                // Requerimientos
                'rq_instalaciones', 'rq_equipo', 'rq_materiales', 'rq_humanos', 'rq_seguridad',
                // Encuadre y Cierre
                'enc_1_presentacion', 'enc_2_curso', 'enc_3_evaluacion', 'enc_4_acuerdos', 'enc_5_diagnostico',
                'cierre_1_resumen', 'cierre_2_logro', 'cierre_3_sugerencias', 'cierre_4_satisfaccion', 'cierre_5_despedida'
            ];

            let filled = 0;
            requiredIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value.trim() !== '') filled++;
            });

            // Validar que haya al menos 1 tema con nombre
            if (document.getElementById('tema1_nombre') && document.getElementById('tema1_nombre').value.trim() !== '') filled++;

            const total = requiredIds.length + 1;
            const pct = Math.round((filled / total) * 100);

            // Actualizar UI
            const bar = document.getElementById('progressBar');
            const ind = document.getElementById('validationIndicator');
            
            bar.style.width = pct + '%';
            
            if (pct >= 80) { // Umbral del 80%
                ind.className = 'validation-indicator valid';
                ind.innerHTML = `<i class="fas fa-check-circle"></i> ${pct}% Completo`;
            } else {
                ind.className = 'validation-indicator invalid';
                ind.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${pct}% Completado`;
            }
            ind.style.display = 'flex';

            return pct;
        }

        function collectData() {
            // Recolectar datos del formulario en un objeto limpio
            let data = {
                nombre: document.getElementById('cd_nombre').value,
                duracion: document.getElementById('cd_duracion').value,
                facilitador: document.getElementById('cd_facilitador').value,
                lugar: document.getElementById('cd_lugar').value,
                fecha: document.getElementById('cd_fecha').value,
                modalidad: document.getElementById('cd_modalidad').value,
                proposito: document.getElementById('cd_proposito').value,
                
                perfil: document.getElementById('cd_perfil').value,
                conoc: document.getElementById('cd_conoc').value,
                hab: document.getElementById('cd_hab').value,
                actitudes: document.getElementById('cd_actitudes').value,
                num: document.getElementById('cd_num').value,
                tipo: document.getElementById('cd_tipo').value, // Agregado
                dise帽ador: document.getElementById('cd_dise帽ador').value, // Agregado

                og: {
                    accion: document.getElementById('og_accion').value,
                    cond: document.getElementById('og_cond').value
                },
                
                objetivos: [],
                
                rq: {
                    instalaciones: document.getElementById('rq_instalaciones').value,
                    equipo: document.getElementById('rq_equipo').value,
                    materiales: document.getElementById('rq_materiales').value,
                    humanos: document.getElementById('rq_humanos').value,
                    seguridad: document.getElementById('rq_seguridad').value
                },
                
                ev: {
                    diag_pct: document.getElementById('ev_diag_pct').value,
                    diag_ins: document.getElementById('ev_diag_ins').value,
                    diag_tipo: document.getElementById('ev_diag_tipo').value, // Agregado
                    
                    form_pct: document.getElementById('ev_form_pct').value,
                    form_ins: document.getElementById('ev_form_ins').value,
                    form_tipo: document.getElementById('ev_form_tipo').value, // Agregado

                    sum_pct: document.getElementById('ev_sum_pct').value,
                    sum_ins: document.getElementById('ev_sum_ins').value,
                    sum_tipo: document.getElementById('ev_sum_tipo').value, // Agregado
                    
                    sat_pct: document.getElementById('ev_sat_pct').value, // Agregado
                    sat_ins: document.getElementById('ev_sat_ins').value, // Agregado
                    sat_tipo: document.getElementById('ev_sat_tipo').value // Agregado
                },
                
                // Desarrollo Cronol贸gico Completo
                dev: {
                    verificacion: document.getElementById('dc_verificacion').value, // Agregado
                    precurso_t: document.getElementById('dc_precurso_t').value, // Agregado

                    enc_1: document.getElementById('enc_1_presentacion').value,
                    enc_2: document.getElementById('enc_2_curso').value,
                    enc_3: document.getElementById('enc_3_evaluacion').value,
                    enc_4: document.getElementById('enc_4_acuerdos').value,
                    enc_5: document.getElementById('enc_5_diagnostico').value,
                    encuadre_t: document.getElementById('dc_encuadre_t').value,
                    
                    cierre_1: document.getElementById('cierre_1_resumen').value,
                    cierre_2: document.getElementById('cierre_2_logro').value,
                    cierre_3: document.getElementById('cierre_3_sugerencias').value,
                    cierre_4: document.getElementById('cierre_4_satisfaccion').value,
                    cierre_5: document.getElementById('cierre_5_despedida').value,
                    cierre_t: document.getElementById('dc_cierre_t').value
                },
                
                temas: []
            };

            // Collect Objetivos
            document.querySelectorAll('#objetivosParticulares .box').forEach(div => {
                const i = div.getAttribute('data-op');
                // Obtener dominio activo
                const activeDom = div.querySelector('.dom.active');
                const dom = activeDom ? activeDom.textContent : 'Cognitivo';

                if(document.getElementById(`op${i}_accion`)) {
                    data.objetivos.push({
                        num: i,
                        dom: dom, // Guardar el dominio
                        accion: document.getElementById(`op${i}_accion`).value,
                        cond: document.getElementById(`op${i}_cond`).value,
                        temas: document.getElementById(`op${i}_temas`).value
                    });
                }
            });

            // Collect Temas
            document.querySelectorAll('[data-tema]').forEach(el => {
                const id = el.getAttribute('data-tema');
                data.temas.push({
                    num: id,
                    nombre: document.getElementById(`tema${id}_nombre`).value,
                    duracion: document.getElementById(`tema${id}_duracion`).value,
                    actividades: document.getElementById(`tema${id}_actividades`).value,
                    tecnicas: document.getElementById(`tema${id}_tecnicas`).value,
                    material: document.getElementById(`tema${id}_material`).value
                });
            });

            return data;
        }

        function saveDraft(silent = false) {
            const data = collectData();
            try {
                EC0301Manager.saveData(data);
                if (!silent) {
                    Swal.fire({ icon: 'success', title: 'Guardado', text: 'Tu avance ha sido guardado exitosamente', timer: 1500 });
                }
            } catch (e) {
                console.error(e);
                if (!silent) Swal.fire('Error', 'No se pudo guardar', 'error');
            }
            updateProgress();
        }

        function loadDraft() {
            const data = EC0301Manager.getData();
            if (!data) return;

            // Helper para setear valor si existe
            const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val || ''; };

            // Info
            setVal('cd_nombre', data.nombre);
            setVal('cd_duracion', data.duracion);
            setVal('cd_facilitador', data.facilitador);
            setVal('cd_dise帽ador', data.dise帽ador); // Agregado
            setVal('cd_lugar', data.lugar);
            setVal('cd_fecha', data.fecha);
            setVal('cd_modalidad', data.modalidad);
            setVal('cd_proposito', data.proposito);
            
            // Perfil
            setVal('cd_perfil', data.perfil);
            setVal('cd_conoc', data.conoc);
            setVal('cd_hab', data.hab);
            setVal('cd_actitudes', data.actitudes);
            setVal('cd_num', data.num);
            setVal('cd_tipo', data.tipo); // Agregado

            // OG
            if(data.og) {
                setVal('og_accion', data.og.accion);
                setVal('og_cond', data.og.cond);
                updateOG();
            }

            // RQ
            if(data.rq) {
                setVal('rq_instalaciones', data.rq.instalaciones);
                setVal('rq_equipo', data.rq.equipo);
                setVal('rq_materiales', data.rq.materiales);
                setVal('rq_humanos', data.rq.humanos);
                setVal('rq_seguridad', data.rq.seguridad);
            }

            // EV
            if(data.ev) {
                setVal('ev_min', data.ev.min);
                setVal('ev_escala', data.ev.escala);
                setVal('ev_cert', data.ev.cert);

                setVal('ev_diag_pct', data.ev.diag_pct);
                setVal('ev_diag_ins', data.ev.diag_ins);
                setVal('ev_diag_tipo', data.ev.diag_tipo);

                setVal('ev_form_pct', data.ev.form_pct);
                setVal('ev_form_ins', data.ev.form_ins);
                setVal('ev_form_tipo', data.ev.form_tipo);

                setVal('ev_sum_pct', data.ev.sum_pct);
                setVal('ev_sum_ins', data.ev.sum_ins);
                setVal('ev_sum_tipo', data.ev.sum_tipo);
                
                setVal('ev_sat_pct', data.ev.sat_pct);
                setVal('ev_sat_ins', data.ev.sat_ins);
                setVal('ev_sat_tipo', data.ev.sat_tipo);
            }

            // DEV (Encuadre/Cierre)
            if(data.dev) {
                setVal('dc_verificacion', data.dev.verificacion);
                setVal('dc_precurso_t', data.dev.precurso_t);

                setVal('enc_1_presentacion', data.dev.enc_1);
                setVal('enc_2_curso', data.dev.enc_2);
                setVal('enc_3_evaluacion', data.dev.enc_3);
                setVal('enc_4_acuerdos', data.dev.enc_4);
                setVal('enc_5_diagnostico', data.dev.enc_5);
                setVal('dc_encuadre_t', data.dev.encuadre_t);
                
                setVal('cierre_1_resumen', data.dev.cierre_1);
                setVal('cierre_2_logro', data.dev.cierre_2);
                setVal('cierre_3_sugerencias', data.dev.cierre_3);
                setVal('cierre_4_satisfaccion', data.dev.cierre_4);
                setVal('cierre_5_despedida', data.dev.cierre_5);
                setVal('dc_cierre_t', data.dev.cierre_t);
            }

            // Objetivos (Deben existir los boxes antes de llenarlos, pero ya los creamos fijos en initForm o aqui)
            // Dado que en initForm creamos 4 por defecto, solo llenamos.
            if(data.objetivos && data.objetivos.length > 0) {
                data.objetivos.forEach(obj => {
                    setVal(`op${obj.num}_accion`, obj.accion);
                    setVal(`op${obj.num}_cond`, obj.cond);
                    setVal(`op${obj.num}_temas`, obj.temas);
                    // Seleccionar dominio
                    if(obj.dom) selDom(obj.num, obj.dom.toLowerCase());
                });
            }

            // Temas
            if(data.temas && data.temas.length > 0) {
                // Limpiar contenedor primero (excepto el 1 si est谩 vac铆o, pero mejor reconstruir)
                const container = document.getElementById('temasContainer');
                container.innerHTML = '';
                temasCount = 0;
                data.temas.forEach(t => {
                    addTema(); // Crea el HTML e incrementa temasCount
                    setVal(`tema${temasCount}_nombre`, t.nombre);
                    setVal(`tema${temasCount}_duracion`, t.duracion);
                    setVal(`tema${temasCount}_actividades`, t.actividades);
                    setVal(`tema${temasCount}_tecnicas`, t.tecnicas);
                    setVal(`tema${temasCount}_material`, t.material);
                });
            }
        }

        // ========== COMPLETAR ==========
        async function markComplete() {
            const porcentaje = updateProgress();

            if (porcentaje < 80) {
                await Swal.fire({
                    title: 'Documento incompleto',
                    text: `Llevas ${porcentaje}%. Necesitas al menos 80% para completar esta etapa.`,
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            const result = await Swal.fire({
                title: '驴Marcar como completado?',
                text: 'Esto guardar谩 la carta y desbloquear谩 el m贸dulo de "Log铆stica y formatos" en tu Dashboard.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S铆, completar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#22C55E'
            });

            if (!result.isConfirmed) return;

            // Guardado silencioso
            saveDraft(true);

            //  Disparador del avance global: marcar m贸dulo "carta"
            try {
                if (typeof EC0301Manager !== 'undefined') {
                    EC0301Manager.markModuleProgress('carta', porcentaje);
                }
            } catch (e) {
                console.error('[Carta] Error al marcar progreso del m贸dulo carta:', e);
            }

            await Swal.fire({
                title: '隆Completado!',
                text: 'La carta descriptiva est谩 completa. Puedes continuar con Log铆stica y formatos.',
                icon: 'success',
                confirmButtonText: 'Ir al Dashboard',
                timer: 2000,
                timerProgressBar: true
            });

            window.location.href = 'acceso.html';
        }
    </script>
</body>
</html>
